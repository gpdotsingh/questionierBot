version: 1

dataset:
  name: donor_summary
  description: >
    One row per donor (summary). Columns include DonorID, LastDonationDate,
    TotalGifts, TotalAmountDonated, State, EngagementScore, EventParticipation, etc.
  granularity: donor   # NOT transaction-level
  time_column: LastDonationDate

normalization:
  date:
    parse_formats: ["%m/%d/%Y", "%Y-%m-%d", "%m-%d-%Y"]
    coerce_invalid_to_null: true
  state:
    uppercase: true
    strip: true
    expected_pattern: "^[A-Z]{2}$"
  email:
    lowercase: true
    trim: true
  phone:
    trim: true

dimensions:
  donor_id:
    column: DonorID
    type: string
    required: true
    synonyms: ["donor", "donor id", "donorid", "id", "supporter"]
  first_name:
    column: FirstName
    type: string
    synonyms: ["first name", "fname", "given name"]
  last_name:
    column: LastName
    type: string
    synonyms: ["last name", "lname", "surname", "family name"]
  email:
    column: Email
    type: string
    synonyms: ["email address", "mail"]
  phone:
    column: Phone
    type: string
    synonyms: ["telephone", "mobile", "contact number"]
  city:
    column: City
    type: string
    synonyms: ["town"]
  state:
    column: State
    type: string
    synonyms: ["province", "region", "state code"]
    validators:
      - name: two_letter_code
        type: regex
        pattern: "^[A-Z]{2}$"
  zip_code:
    column: ZipCode
    type: string
    synonyms: ["zip", "postal code"]
  donation_date:
    column: LastDonationDate
    type: date
    synonyms: ["last donation", "most recent gift date", "last gift"]
  total_gifts:
    column: TotalGifts
    type: number
    synonyms: ["gift count", "gifts", "num gifts"]
  total_amount_donated:
    column: TotalAmountDonated
    type: number
    currency: "USD"   # or EUR if you converted; keep consistent with data
    synonyms: ["total donated", "lifetime total", "donation total", "sum donated"]
  engagement_score:
    column: EngagementScore
    type: number
    synonyms: ["engagement", "score"]
  event_participation:
    column: EventParticipation
    type: categorical
    values_map:
      yes: ["Yes", "Y", "True", "1"]
      no:  ["No", "N", "False", "0"]
    synonyms: ["event", "participation", "attended event"]

derived:
  # Booleans that your orchestrator can compute on load.
  fields:
    is_active_30d:
      expr: "donation_date >= now() - 30d"
    is_active_45d:
      expr: "donation_date >= now() - 45d"
    is_active_60d:
      expr: "donation_date >= now() - 60d"
    is_active_90d:
      expr: "donation_date >= now() - 90d"
    is_inactive_120d:
      expr: "donation_date < now() - 120d"
    days_since_last:
      expr: "days_between(now(), donation_date)"

  buckets:
    engagement_decile:
      expr: "ntile(engagement_score, 10)"
    engagement_band:
      rules:
        - when: "engagement_score >= p75(engagement_score)"
          then: "high"
        - when: "engagement_score <= p25(engagement_score)"
          then: "low"
        - else: "medium"
    gift_count_band:
      rules:
        - when: "total_gifts >= 10"  # heavy repeat givers
          then: "many"
        - when: "total_gifts <= 3"
          then: "few"
        - else: "moderate"

metrics:
  # NOTE: On a donor-summary file, any "monthly total_donation_amount" rollup is invalid.
  # We therefore expose only metrics that make sense at donor granularity.
  donor_count_last_n_days:
    description: "Number of distinct donors active in the last N days."
    input_required: ["window_days"]
    valid_grains: ["period_only"]  # no monthly/weekly bins from summary file
    compute:
      filter: "donation_date >= now() - {window_days}d"
      agg: "nunique(donor_id)"
  median_total_last_n_days:
    description: "Median per-donor 'amount' among donors active in last N days."
    input_required: ["window_days"]
    compute:
      filter: "donation_date >= now() - {window_days}d"
      group_by: ["donor_id"]
      value: "max(amount)"   # per-donor figure already summary; keep max as stable proxy
      agg: "median"

  donor_count_by_state_last_n_days:
    description: "Active donor count by state in last N days."
    input_required: ["window_days"]
    compute:
      filter: "donation_date >= now() - {window_days}d"
      group_by: ["state"]
      agg: "nunique(donor_id)"

  median_total_by_state_last_n_days:
    description: "Median per-donor amount by state in last N days."
    input_required: ["window_days"]
    compute:
      filter: "donation_date >= now() - {window_days}d"
      group_by: ["state","donor_id"]
      value: "max(amount)"
      agg: "median_per_state"

  engagement_median_last_n_days:
    description: "Median engagement score among donors active in last N days."
    input_required: ["window_days"]
    compute:
      filter: "donation_date >= now() - {window_days}d"
      agg: "median(engagement_score)"

  event_participation_share_last_n_days:
    description: "Share of active donors that are event participants in last N days."
    input_required: ["window_days"]
    compute:
      filter: "donation_date >= now() - {window_days}d"
      numerator: "count_if(event_participation == 'yes')"
      denominator: "count()"
      agg: "ratio"

  # Trend-safe proxy metrics that DO work on summary:
  donor_count_trend_monthly:
    description: "Monthly count of active donors (based on LastDonationDate month)."
    caveat: "Proxy trend from summary; OK because it's counts by last-activity month."
    compute:
      resample: "MS"   # month start
      index: "donation_date"
      agg: "count_distinct(donor_id)"

  # Guards for asks we must reject on summary data
  INVALID_total_donation_amount_monthly:
    description: "Monthly total donated cannot be computed from donor-summary file."
    invalid_on: ["donor_summary"]
    message: "Cannot compute monthly totals without gift-level rows."

planner_hints:
  # Helps your agentic splitter/planner convert natural language → metric + options
  synonyms_to_metric:
    - keys: ["how many donors", "count donors", "active donors"]
      metric: "donor_count_last_n_days"
    - keys: ["median per-donor total", "median donation per donor"]
      metric: "median_total_last_n_days"
    - keys: ["by state", "state wise", "group by state"]
      group_by_state: true
    - keys: ["last 30 days", "past month"]
      window_days: 30
    - keys: ["last 45 days"]
      window_days: 45
    - keys: ["last 60 days", "past 2 months"]
      window_days: 60
    - keys: ["last 90 days", "past quarter"]
      window_days: 90
    - keys: ["engagement"]
      metric_hint: "engagement_median_last_n_days"
    - keys: ["event participants", "event participation"]
      metric_hint: "event_participation_share_last_n_days"
    - keys: ["trend", "increasing", "declining"]
      check_trend: true
  grains:
    allowed: ["period_only"]  # since donor summary; prevent monthly totals on amount
  state_detection:
    # Regex to capture explicit state filters in text; inject into filter if present.
    regex: "\\b(AL|AK|AZ|AR|CA|CO|CT|DE|FL|GA|HI|IA|ID|IL|IN|KS|KY|LA|MA|MD|ME|MI|MN|MO|MS|MT|NC|ND|NE|NH|NJ|NM|NV|NY|OH|OK|OR|PA|RI|SC|SD|TN|TX|UT|VA|VT|WA|WI|WV|DC)\\b"
    case_sensitive: false
  defaults:
    window_days: 90
    group_by_state: false

guards:
  # Used by your validator/repair loop
  rules:
    - name: forbid_monthly_amount_on_summary
      when:
        dataset.granularity == "donor" and ask.metric in ["total_donation_amount", "total_gifts"] and ask.grain in ["monthly","weekly","daily"]
      action: error
      message: "Monthly/weekly totals require gift-level data. Provide transaction file."
    - name: require_time_window_for_active
      when:
        ask.metric in ["donor_count_last_n_days","median_total_last_n_days","median_total_by_state_last_n_days","engagement_median_last_n_days","event_participation_share_last_n_days"]
        and not ask.window_days
      action: inject_default
      inject:
        window_days: 90
    - name: group_by_state_toggle
      when:
        "by state" 
      action: set_flag
      set:
        group_by_state: true

presentation:
  formatting:
    currency_fields: ["amount"]
    percent_fields: ["event_participation_share_last_n_days"]
    integer_fields: ["donor_count_last_n_days", "donor_count_by_state_last_n_days"]
  narrative_templates:
    donor_count_last_n_days: |
      In the last {window_days} days, {value} donors were active.
    median_total_last_n_days: |
      In the last {window_days} days, the median per-donor total was {value:.2f}.
    donor_count_by_state_last_n_days: |
      Active donors by state (last {window_days} days): {topk}.
    median_total_by_state_last_n_days: |
      Median per-donor totals by state (last {window_days} days): {topk}.
    engagement_median_last_n_days: |
      In the last {window_days} days, median engagement score was {value:.0f}.
    event_participation_share_last_n_days: |
      In the last {window_days} days, {value:.1%} of active donors participated in events.

vectorization:
  # Guidance for building row-level text for Chroma (used by your ingest job)
  row_template: |
    DonorID: {DonorID}
    FirstName: {FirstName}
    LastName: {LastName}
    Email: {Email}
    Phone: {Phone}
    City: {City}
    State: {State}
    ZipCode: {ZipCode}
    LastDonationDate: {LastDonationDate}
    TotalGifts: {TotalGifts}
    TotalAmountDonated: {TotalAmountDonated}
    EventParticipation: {EventParticipation}
    EngagementScore: {EngagementScore}
  metadata:
    source: "{csv_path}"
    row: "{row_index}"
  split:
    chunk_by: "row"
    chunk_size: 1
    overlap: 0
  embeddings:
    provider_priority: ["ollama:nomic-embed-text", "hf:sentence-transformers/all-MiniLM-L6-v2"]
    normalize: true

examples:
  # A few NL → plan interpretations to help the planner
  - text: "How many donors gave in the last 90 days?"
    plan:
      metric: donor_count_last_n_days
      window_days: 90
  - text: "Show median per-donor total by state for the past 60 days (top 3)."
    plan:
      metric: median_total_by_state_last_n_days
      window_days: 60
      group_by_state: true
      top_k: 3
  - text: "Are state codes two-letter abbreviations?"
    plan:
      check: state_format
      validator: two_letter_code
  - text: "Is donation momentum declining?"
    plan:
      metric: donor_count_trend_monthly
      compare_windows:
        recent_days: 90
        prior_days: 90
      check_decline: true
